<html>

<head>
  <meta charset="utf-8" />
  <title>Display a basemap layer</title>
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>

  <!-- Load Esri Leaflet Vector from CDN -->
  <script src="https://unpkg.com/esri-leaflet-vector@4.0.1/dist/esri-leaflet-vector.js" crossorigin=""></script>

  <!-- Load Esri Leaflet Geocoder from CDN (for search bar) -->
  <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@3.1.4/dist/esri-leaflet-geocoder.css"
    crossorigin="" />
  <script src="https://unpkg.com/esri-leaflet-geocoder@3.1.4/dist/esri-leaflet-geocoder.js" crossorigin=""></script>

  <style>
    html,
    body,
    #map {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 14px;
      color: #323232;
    }
  </style>
</head>

<body>
  <div id="map"></div>
   <!-- import api key, should keep the api key private -->
  <script type='text/javascript' src='config.js'></script>
  <script>
    const apiKey = config.API_KEY;

    const map = L.map("map").setView([42.2449, -71.2935], 11);

    //Base Light map with labels

    base = L.esri.Vector.vectorBasemapLayer("ArcGIS:LightGray:Base", {
      apikey: apiKey,
      pane: "tilePane" // Change pane to allow for multiple vector basemaps
    }).addTo(map);

    L.esri.Vector.vectorBasemapLayer("ArcGIS:LightGray:Labels", {
      apikey: apiKey
    }).addTo(map);

    // CRW boundary style
    const boundaryStyle = {
      "color": "#82eefd",
      "weight": 3,
      "opacity": 0.65
    };

    // Add CRW boundary
    const boundaryLayer = L.esri
      .featureLayer({
        url: "https://services2.arcgis.com/Kuf0uTOqI2C0lE9a/ArcGIS/rest/services/CRWboundary/FeatureServer/0",
        style: () => {return boundaryStyle}
      });
    boundaryLayer.addTo(map);

    // icon for mainstem dams
    const mainstemDamIcon = L.icon({
      iconUrl: "https://upload.wikimedia.org/wikipedia/commons/4/47/Squared_dot.svg",
      iconSize: [38, 38]
    })

    // Add mainstem dam layer
    const mainstemDamURL = "https://services2.arcgis.com/Kuf0uTOqI2C0lE9a/ArcGIS/rest/services/mainstem%20dams/FeatureServer/0";

    const mainstemDams = L.esri
      .featureLayer({
        url: mainstemDamURL,
        pointToLayer: function (geojson, latlng) {
          return L.marker(latlng, {
            icon: mainstemDamIcon
          });
        }
      });

    // Popup with mainstem dam information
    mainstemDams.bindPopup(function (layer) {
      return L.Util.template(
        ` <h3> {DAMNAME} </h3>
            <ul>
            <li> <strong> Owner: </strong> {OWNTYPE3} </li>
            <li> <strong> Hazard Level: </strong> {HAZCODE}</li>
            <li> <strong> Condition: </strong> {Condition}</li>
            <li> <strong> Fish Passage: </strong> {Fish_Passage}</li>
            </ul>`,
        layer.feature.properties
      );
    });
    mainstemDams.addTo(map);

    // add mainstem dams to search
    const mainstemDamSearch = L.esri.Geocoding.featureLayerProvider({
      url: mainstemDamURL,
      searchFields: ["DAMNAME"],
      label: "mainstem dams",
      bufferRadius: 100,
      formatSuggestion: function (feature) {
        return feature.properties.DAMNAME;
      }
    });

    // icon for tributary dams
    const tributaryDamIcon = L.icon({
      iconUrl: "https://upload.wikimedia.org/wikipedia/commons/4/47/Squared_dot.svg",
      iconSize: [27, 27]
    })

    // Add tributary dam layer
    const tributaryDamURL = "https://services2.arcgis.com/Kuf0uTOqI2C0lE9a/ArcGIS/rest/services/tributary%20dams/FeatureServer/0";

    const tributaryDams = L.esri
      .featureLayer({
        url: tributaryDamURL,
        minZoom: 11, // only show tributary dams when zoomed in
        pointToLayer: function (geojson, latlng) {
          return L.marker(latlng, {
            icon: tributaryDamIcon
          });
        }
      });

    // Popup with tributary dam information
    tributaryDams.bindPopup(function (layer) {
      return L.Util.template(
        ` <h3> {DAMNAME} </h3>
            <ul>
            <li> <strong> Owner: </strong> {OWNTYPE3} </li>
            <li> <strong> Hazard Level: </strong> {HAZCODE}</li>
            </ul>`,
        layer.feature.properties
      );
    });
    tributaryDams.addTo(map);

    // add tributary dams to search
    const tributaryDamSearch = L.esri.Geocoding.featureLayerProvider({
      url: tributaryDamURL,
      maxResults: 15,
      searchFields: ["DAMNAME"],
      label: "tributary dams",
      bufferRadius: 100,
      formatSuggestion: function (feature) {
        return feature.properties.DAMNAME;
      }
    });

    // Charles River style
    const charlesRiverStyle = {
      "weight": 2.5,
    };

    // Add Charles River Overlay
    const charlesRiver = L.esri
      .featureLayer({
        url: "https://services2.arcgis.com/Kuf0uTOqI2C0lE9a/ArcGIS/rest/services/charlesriver/FeatureServer/0",
        style: () => {return charlesRiverStyle}
      });
    charlesRiver.addTo(map);

    //ICONS FOR CULVERTS 1. find a url for the icon that you want, and adjust the icon to whatever size you desire
    // 1: 'no score-missing data'
    const noDataIcon = L.icon({
      iconUrl: "https://www.freepnglogos.com/uploads/circle-png/black-circle-thin-icon-download-9.png",
      iconSize: [7, 7]
    })
    // 2: 'Severe barrier'
    const severeIcon = L.icon({
      iconUrl: "https://upload.wikimedia.org/wikipedia/commons/0/0e/Basic_red_dot.png",
      iconSize: [12, 12]
    })
    // 3: 'Significant barrier'
    const significantIcon = L.icon({
      iconUrl: "https://www.clker.com/cliparts/m/I/n/1/T/P/orange-dot-md.png",
      iconSize: [12, 12]
    })
    // 4: 'Moderate barrier'
    const moderateIcon = L.icon({
      iconUrl: "https://www.citypng.com/public/uploads/small/11641513619acx4mjbgnw1xgx9gxmytt6sa8jevdsehtrlm6waaxumbtcvj79xpopyjf2ef4ajtw55wbhb4z231dq2zda0xs11jc6m6yzolvvtu.png",
      iconSize: [20, 20]
    })
    // 5: 'Minor barrier'
    const minorIcon = L.icon({
      iconUrl: "https://upload.wikimedia.org/wikipedia/commons/7/7c/GAudit_YellowDot.png",
      iconSize: [12, 12]
    })
    // 6: 'Insignicant barrier'
    const insignicantIcon = L.icon({
      iconUrl: "https://www.pngkey.com/png/full/417-4174990_how-to-set-use-small-green-dot-icon.png",
      iconSize: [12, 12]
    })
    // 7: 'No barrier'
    const noBarrierIcon = L.icon({
      iconUrl: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Location_dot_green.svg/640px-Location_dot_green.svg.png",
      iconSize: [12, 12]
    })

    //map with all of the icons for organization purpose
    const culvertIcons = {
      "no score - missing data": noDataIcon,
      "Severe barrier": severeIcon,
      "Significant barrier": significantIcon,
      "Moderate barrier": moderateIcon,
      "Minor barrier": minorIcon,
      "Insignificant barrier": insignicantIcon,
      "No barrier": noBarrierIcon,
    }


    //culvert layer from shapefile
    const culvertURL = "https://services2.arcgis.com/Kuf0uTOqI2C0lE9a/arcgis/rest/services/culverts%20final/FeatureServer/0";

    const culverts = L.esri
      .featureLayer({
        url: culvertURL,
        minZoom: 12, // only show culverts when zoomed in 
        pointToLayer: function (geojson, latlng) {

          if (geojson.properties.gWshed === 'Charles') { //filter for charles watershed only
            if (geojson.properties.Assessed === "0") { //unassessed culverts
              return L.marker(latlng, {icon: noDataIcon});
            }
            //using the map created above, simply grab the icon by the name, eg. culvertIcons["Severe barrier"]
            return L.marker(latlng, {
              icon: culvertIcons[geojson.properties.Eval]
            });
          }
        }
      });


    // Popup with culverts information
    culverts.bindPopup(function (layer) {

      if (layer.feature.properties.Assessed === "0") { //if not assessed
        return L.Util.template(
          `<p>No data available. This culvert has not been assessed!</p>`, layer.feature.properties
        );
      }

      return L.Util.template(
        ` <h4>Culvert: {StrmName} at {Road} </h4> 
        <ul>
          <li> <strong> Date Observed: </strong> {DateObsd} </li>
          <li> <strong> Aquatic Passage: </strong> {Eval} </li>
          </ul>`,
        layer.feature.properties
      );

    });

    culverts.addTo(map);

    // add culverts to search 
    const culvertSearch = L.esri.Geocoding.featureLayerProvider({
      url: culvertURL,
      maxResults: 15,
      searchFields: ["StrmName", "Road"],
      label: "culverts",
      bufferRadius: 60,
      formatSuggestion: function (feature) {
        return feature.properties.StrmName + " at " + feature.properties.Road;
      }
    });

    // stream style
    const streamStyle = {
      "weight": 1,
    };

    // add streams
    const streams = L.esri
      .featureLayer({
        url: "https://services2.arcgis.com/Kuf0uTOqI2C0lE9a/arcgis/rest/services/streams in CRW/FeatureServer/0",
        style: () => {return streamStyle}
      });

    streams.addTo(map);

    // pond style
    const pondStyle = {
      "weight": 1,
    };

    // add ponds
    const ponds = L.esri
      .featureLayer({
        url: "https://services2.arcgis.com/Kuf0uTOqI2C0lE9a/arcgis/rest/services/ponds in CRW/FeatureServer/0",
        style: () => {return pondStyle}
      });

    ponds.addTo(map);

    // create control panel for feature layers
    const layers = {
      Base: base
    };

    const overlays = {
      "Charles River Watershed Boundary": boundaryLayer,
      "Charles River": charlesRiver,
      "Streams": streams,
      "Ponds and Lakes": ponds,
      "Dams (Mainstem)": mainstemDams,
      "Dams (Tributary)": tributaryDams,
      "Culverts": culverts,
    };

    // https://leafletjs.com/reference.html#control-layers
    L.control.layers(layers, overlays,
      {hideSingleBase: true}).addTo(map);


    // search bar: https://developers.arcgis.com/esri-leaflet/api-reference/controls/geosearch/
    L.esri.Geocoding.geosearch({
      providers: [mainstemDamSearch, tributaryDamSearch, culvertSearch],
      useMapBounds: false,
      placeholder: 'Enter dam or culvert name'
    }).addTo(map);


  </script>

</body>

</html>